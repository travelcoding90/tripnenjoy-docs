<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trip & Enjoy - Portal de Viajes</title>
    <link rel="icon" href="https://i.postimg.cc/WNbxj55s/Favicon-T-E-(2).png">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="module">
        import React, { useState, useEffect } from 'https://esm.sh/react@18';
        import ReactDOM from 'https://esm.sh/react-dom@18/client';
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        const SUPABASE_URL = 'https://txmfjhhjyjjktgluyjzj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR4bWZqaGhqeWpqa3RnbHV5anpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNzU4ODEsImV4cCI6MjA4MzY1MTg4MX0.Qab1gujJBQDfOxeuP5v5pWYO-x5ARGiOkgTaF5aeVyk';
        const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
        const ADMIN_PASS = 'tripnenjoy2025';

        function App() {
            const [trips, setTrips] = useState([]);
            const [code, setCode] = useState('');
            const [curr, setCurr] = useState(null);
            const [admin, setAdmin] = useState(false);
            const [pass, setPass] = useState('');
            const [auth, setAuth] = useState(false);
            const [logo, setLogo] = useState('https://i.postimg.cc/WNbxj55s/Favicon-T-E-(2).png');
            const [newCode, setNewCode] = useState('');
            const [editInfo, setEditInfo] = useState(false);
            const [loading, setLoading] = useState(true);
            const [docs, setDocs] = useState([]);
            const [pageTitle, setPageTitle] = useState('Documentos de tu Viaje');
            const [editingTitle, setEditingTitle] = useState(false);

            const cats = {
                aereos: { n: 'Vuelos', i: 'âœˆï¸', c: 'bg-[#197751]' },
                hoteles: { n: 'Hoteles', i: 'ðŸ¨', c: 'bg-[#197751]' },
                transportes: { n: 'Transportes', i: 'ðŸš—', c: 'bg-[#197751]' },
                traslados: { n: 'Traslados', i: 'ðŸ“', c: 'bg-[#197751]' },
                actividades: { n: 'Actividades', i: 'ðŸ§­', c: 'bg-[#197751]' },
                circuitos: { n: 'Circuitos', i: 'ðŸ—ºï¸', c: 'bg-[#197751]' },
                seguroMedico: { n: 'Seguro', i: 'ðŸ›¡ï¸', c: 'bg-[#197751]' },
                otros: { n: 'Otros', i: 'ðŸ“„', c: 'bg-[#197751]' }
            };

            const loadTrips = async () => {
                setLoading(true);
                const { data } = await sb.from('trips').select('*').order('created_at', { ascending: false });
                setTrips(data || []);
                setLoading(false);
            };

            const loadDocs = async (tripId) => {
                const { data } = await sb.from('documents').select('*').eq('trip_id', tripId);
                setDocs(data || []);
            };

            const loadLogo = async () => {
                const { data } = await sb.from('config').select('value').eq('key', 'logo').single();
                if (data) setLogo(data.value);
            };

            const loadPageTitle = async () => {
                try {
                    const { data } = await sb.from('config').select('value').eq('key', 'page_title').single();
                    if (data) setPageTitle(data.value);
                } catch (e) {
                    await sb.from('config').insert([{ key: 'page_title', value: 'Documentos de tu Viaje' }]);
                }
            };

            useEffect(() => { loadTrips(); loadLogo(); loadPageTitle(); }, []);

            const savePageTitle = async (newTitle) => {
                await sb.from('config').upsert({ key: 'page_title', value: newTitle });
                setPageTitle(newTitle);
            };

            const access = () => {
                const c = code.toUpperCase().trim();
                const trip = trips.find(t => t.code === c);
                if (trip) { setCurr(trip); setCode(''); loadDocs(trip.id); } else alert('CÃ³digo invÃ¡lido');
            };

            const login = () => { if (pass === ADMIN_PASS) { setAuth(true); setPass(''); } else alert('ContraseÃ±a incorrecta'); };

            const create = async () => {
                const c = newCode.toUpperCase().trim();
                if (!c) { alert('Ingresa cÃ³digo'); return; }
                if (trips.find(t => t.code === c)) { alert('Ya existe'); return; }
                const { data, error } = await sb.from('trips').insert([{ code: c }]).select().single();
                if (error) { alert('Error: ' + error.message); return; }
                await loadTrips();
                setCurr(data);
                loadDocs(data.id);
                setNewCode('');
            };

            const updateTrip = async (field, value) => {
                await sb.from('trips').update({ [field]: value }).eq('id', curr.id);
                await loadTrips();
                const updated = trips.find(t => t.id === curr.id);
                if (updated) setCurr(updated);
            };

            const delTrip = async (id, c) => {
                if (!confirm(`Â¿Eliminar ${c}?`)) return;
                await sb.from('trips').delete().eq('id', id);
                await loadTrips();
                if (curr?.id === id) setCurr(null);
            };

            const upLogo = async (e) => {
                const f = e.target.files[0];
                if (!f) return;
                const r = new FileReader();
                r.onload = async (ev) => {
                    await sb.from('config').update({ value: ev.target.result }).eq('key', 'logo');
                    setLogo(ev.target.result);
                };
                r.readAsDataURL(f);
            };

            const upFile = async (e, cat) => {
                const fs = Array.from(e.target.files);
                for (const f of fs) {
                    const r = new FileReader();
                    r.onload = async (ev) => {
                        await sb.from('documents').insert([{
                            trip_id: curr.id,
                            category: cat,
                            display_name: f.name.replace('.pdf', ''),
                            file_name: f.name,
                            file_data: ev.target.result
                        }]);
                        await loadDocs(curr.id);
                    };
                    r.readAsDataURL(f);
                }
            };

            const delDoc = async (id) => {
                if (!confirm('Â¿Eliminar?')) return;
                await sb.from('documents').delete().eq('id', id);
                await loadDocs(curr.id);
            };

            const download = (d) => {
                const l = document.createElement('a');
                l.href = d.file_data;
                l.download = d.file_name;
                l.click();
            };

            const downloadAll = () => {
                let t = 0;
                docs.forEach(d => { setTimeout(() => download(d), t); t += 300; });
            };

            const fmt = d => d ? new Date(d).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : '';
            const getDocsByCat = (cat) => docs.filter(d => d.category === cat);

            if (loading) return React.createElement('div', { className: 'min-h-screen bg-white flex items-center justify-center' },
                React.createElement('div', { className: 'text-center' },
                    React.createElement('div', { className: 'text-6xl mb-4' }, 'â³'),
                    React.createElement('p', { className: 'text-xl text-gray-600' }, 'Cargando...')
                )
            );

            // PANTALLA PRINCIPAL - Minimalista y centrada
            if (!curr && !admin) return React.createElement('div', { className: 'min-h-screen bg-white flex items-center justify-center p-6' },
                React.createElement('div', { className: 'max-w-sm w-full text-center' },
                    React.createElement('img', { src: logo, className: 'h-32 w-32 mx-auto mb-8 object-contain' }),
                    React.createElement('input', {
                        type: 'text',
                        value: code,
                        onChange: e => setCode(e.target.value.toUpperCase()),
                        onKeyPress: e => e.key === 'Enter' && access(),
                        placeholder: 'CÃ“DIGO DEL VIAJE',
                        className: 'w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:outline-none focus:border-[#197751] text-center text-lg font-semibold uppercase mb-4'
                    }),
                    React.createElement('button', {
                        onClick: access,
                        className: 'w-full px-6 py-3 bg-[#197751] text-white rounded-lg hover:bg-[#145a3e] font-semibold mb-6'
                    }, 'Acceder'),
                    React.createElement('button', {
                        onClick: () => setAdmin(true),
                        className: 'text-gray-400 text-sm hover:text-gray-600'
                    }, 'Admin')
                )
            );

            if (admin && !auth) return React.createElement('div', { className: 'min-h-screen bg-white flex items-center justify-center p-6' },
                React.createElement('div', { className: 'max-w-sm w-full text-center' },
                    React.createElement('h2', { className: 'text-2xl font-bold mb-6' }, 'Admin'),
                    React.createElement('input', {
                        type: 'password',
                        value: pass,
                        onChange: e => setPass(e.target.value),
                        onKeyPress: e => e.key === 'Enter' && login(),
                        placeholder: 'ContraseÃ±a',
                        className: 'w-full px-4 py-3 border-2 border-gray-200 rounded-lg mb-4 focus:outline-none focus:border-[#197751]'
                    }),
                    React.createElement('button', {
                        onClick: login,
                        className: 'w-full px-6 py-3 bg-[#197751] text-white rounded-lg hover:bg-[#145a3e] mb-3'
                    }, 'Entrar'),
                    React.createElement('button', {
                        onClick: () => setAdmin(false),
                        className: 'w-full px-6 py-3 text-gray-500 hover:text-gray-700'
                    }, 'Volver')
                )
            );

            // PANEL ADMIN - MÃ¡s estÃ©tico
            if (auth) {
                return React.createElement('div', { className: 'min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-6' },
                    React.createElement('div', { className: 'max-w-7xl mx-auto' },
                        React.createElement('div', { className: 'bg-white rounded-2xl shadow-sm p-8 mb-6' },
                            React.createElement('div', { className: 'flex justify-between items-center mb-8' },
                                React.createElement('h1', { className: 'text-3xl font-bold text-gray-800' }, 'Panel de AdministraciÃ³n'),
                                React.createElement('button', {
                                    onClick: () => { setAuth(false); setAdmin(false); setCurr(null); },
                                    className: 'px-5 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition'
                                }, 'Cerrar SesiÃ³n')
                            ),

                            React.createElement('div', { className: 'grid md:grid-cols-2 gap-6 mb-6' },
                                React.createElement('div', { className: 'border border-gray-200 rounded-xl p-6' },
                                    React.createElement('h3', { className: 'text-lg font-semibold mb-4 text-gray-700' }, 'ðŸŽ¨ Logo de la Agencia'),
                                    React.createElement('input', {
                                        type: 'file',
                                        accept: 'image/*',
                                        onChange: upLogo,
                                        className: 'block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#197751] file:text-white hover:file:bg-[#145a3e] cursor-pointer'
                                    }),
                                    React.createElement('img', { src: logo, className: 'h-20 w-20 mt-4 border border-gray-200 rounded-lg object-contain' })
                                ),

                                React.createElement('div', { className: 'border border-gray-200 rounded-xl p-6' },
                                    React.createElement('h3', { className: 'text-lg font-semibold mb-4 text-gray-700' }, 'ðŸ“ TÃ­tulo de PÃ¡gina'),
                                    editingTitle ? React.createElement('div', { className: 'flex gap-2' },
                                        React.createElement('input', {
                                            type: 'text',
                                            value: pageTitle,
                                            onChange: e => setPageTitle(e.target.value),
                                            className: 'flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:border-[#197751]'
                                        }),
                                        React.createElement('button', {
                                            onClick: () => { savePageTitle(pageTitle); setEditingTitle(false); },
                                            className: 'px-4 py-2 bg-[#197751] text-white rounded-lg hover:bg-[#145a3e]'
                                        }, 'Guardar')
                                    ) : React.createElement('div', { className: 'flex justify-between items-center' },
                                        React.createElement('p', { className: 'text-gray-600' }, pageTitle),
                                        React.createElement('button', {
                                            onClick: () => setEditingTitle(true),
                                            className: 'text-[#197751] hover:text-[#145a3e]'
                                        }, 'Editar')
                                    )
                                )
                            ),

                            React.createElement('div', { className: 'border border-gray-200 rounded-xl p-6 mb-6' },
                                React.createElement('h3', { className: 'text-lg font-semibold mb-4 text-gray-700' }, 'âž• Crear Nuevo Viaje'),
                                React.createElement('div', { className: 'flex gap-3' },
                                    React.createElement('input', {
                                        type: 'text',
                                        value: newCode,
                                        onChange: e => setNewCode(e.target.value.toUpperCase()),
                                        onKeyPress: e => e.key === 'Enter' && create(),
                                        placeholder: 'CÃ“DIGO DEL VIAJE',
                                        className: 'flex-1 px-4 py-3 border border-gray-300 rounded-lg uppercase font-bold focus:outline-none focus:border-[#197751]'
                                    }),
                                    React.createElement('button', {
                                        onClick: create,
                                        className: 'px-8 py-3 bg-[#197751] text-white rounded-lg hover:bg-[#145a3e] font-semibold'
                                    }, 'Crear')
                                )
                            ),

                            React.createElement('div', { className: 'border border-gray-200 rounded-xl p-6' },
                                React.createElement('h3', { className: 'text-lg font-semibold mb-4 text-gray-700' }, `ðŸ“‹ Viajes Existentes (${trips.length})`),
                                React.createElement('div', { className: 'space-y-3' },
                                    trips.map(t => React.createElement('div', { key: t.id, className: 'flex justify-between items-center p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition' },
                                        React.createElement('div', { className: 'flex items-center gap-4' },
                                            React.createElement('span', { className: 'font-mono font-bold text-lg text-[#197751]' }, t.code),
                                            t.destination && React.createElement('span', { className: 'text-sm text-gray-500' }, 'â†’ ' + t.destination)
                                        ),
                                        React.createElement('div', { className: 'flex gap-2' },
                                            React.createElement('button', {
                                                onClick: () => { setCurr(t); loadDocs(t.id); },
                                                className: curr?.id === t.id ? 'px-4 py-2 rounded-lg bg-[#197751] text-white' : 'px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300'
                                            }, curr?.id === t.id ? 'Editando' : 'Editar'),
                                            React.createElement('button', {
                                                onClick: () => delTrip(t.id, t.code),
                                                className: 'px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg'
                                            }, 'ðŸ—‘ï¸')
                                        )
                                    )),
                                    !trips.length && React.createElement('p', { className: 'text-center text-gray-400 py-8' }, 'No hay viajes creados')
                                )
                            )
                        ),

                        curr && React.createElement('div', { className: 'bg-white rounded-2xl shadow-sm p-8' },
                            React.createElement('div', { className: 'flex justify-between items-center mb-6' },
                                React.createElement('h2', { className: 'text-2xl font-bold text-gray-800' }, 'Editando: ' + curr.code),
                                React.createElement('button', {
                                    onClick: () => setEditInfo(!editInfo),
                                    className: 'px-4 py-2 text-[#197751] hover:bg-gray-50 rounded-lg'
                                }, 'âœï¸ ' + (editInfo ? 'Cerrar' : 'Editar Info'))
                            ),

                            editInfo && React.createElement('div', { className: 'border border-gray-200 rounded-xl p-6 mb-6 space-y-4' },
                                React.createElement('input', {
                                    type: 'text',
                                    placeholder: 'Nombre del pasajero',
                                    value: curr.passenger_name || '',
                                    onChange: e => updateTrip('passenger_name', e.target.value),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#197751]'
                                }),
                                React.createElement('input', {
                                    type: 'text',
                                    placeholder: 'Destino',
                                    value: curr.destination || '',
                                    onChange: e => updateTrip('destination', e.target.value),
                                    className: 'w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#197751]'
                                }),
                                React.createElement('div', { className: 'grid grid-cols-2 gap-4' },
                                    React.createElement('input', {
                                        type: 'date',
                                        value: curr.start_date || '',
                                        onChange: e => updateTrip('start_date', e.target.value),
                                        className: 'px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#197751]'
                                    }),
                                    React.createElement('input', {
                                        type: 'date',
                                        value: curr.end_date || '',
                                        onChange: e => updateTrip('end_date', e.target.value),
                                        className: 'px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-[#197751]'
                                    })
                                )
                            ),

                            React.createElement('div', { className: 'grid md:grid-cols-2 gap-6' },
                                Object.keys(cats).map(k => {
                                    const catDocs = getDocsByCat(k);
                                    return React.createElement('div', { key: k, className: 'border border-gray-200 rounded-xl p-6' },
                                        React.createElement('div', { className: 'flex items-center gap-3 mb-4' },
                                            React.createElement('span', { className: 'text-2xl' }, cats[k].i),
                                            React.createElement('h3', { className: 'font-semibold text-gray-700' }, cats[k].n),
                                            React.createElement('span', { className: 'ml-auto text-sm text-gray-400' }, catDocs.length)
                                        ),
                                        React.createElement('input', {
                                            type: 'file',
                                            accept: '.pdf',
                                            multiple: true,
                                            onChange: e => upFile(e, k),
                                            className: 'block w-full text-sm text-gray-500 mb-3 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-[#197751] file:text-white hover:file:bg-[#145a3e] cursor-pointer'
                                        }),
                                        catDocs.length > 0 && React.createElement('div', { className: 'space-y-2' },
                                            catDocs.map(d => React.createElement('div', { key: d.id, className: 'flex justify-between items-center p-2 bg-gray-50 rounded-lg hover:bg-gray-100' },
                                                React.createElement('span', { className: 'text-sm truncate flex-1 text-gray-700' }, d.display_name),
                                                React.createElement('button', {
                                                    onClick: () => delDoc(d.id),
                                                    className: 'text-red-600 text-sm ml-2 hover:text-red-700'
                                                }, 'âœ•')
                                            ))
                                        )
                                    );
                                })
                            )
                        )
                    )
                );
            }

            // VISTA DEL USUARIO - Con todos los ajustes
            const vis = Object.keys(cats).filter(k => getDocsByCat(k).length > 0);

            return React.createElement('div', { className: 'min-h-screen bg-white p-6' },
                React.createElement('div', { className: 'max-w-3xl mx-auto' },
                    React.createElement('div', { className: 'mb-8' },
                        React.createElement('div', { className: 'flex justify-between items-start mb-6' },
                            React.createElement('div', { className: 'flex-1' },
                                React.createElement('h1', { className: 'text-3xl font-bold text-gray-800 mb-2' }, pageTitle),
                                React.createElement('div', { className: 'flex items-center gap-2 mb-2' },
                                    React.createElement('span', { className: 'px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm font-mono font-semibold' }, curr.code)
                                ),
                                curr.passenger_name && React.createElement('p', { className: 'text-gray-600 text-sm' }, curr.passenger_name)
                            ),
                            React.createElement('div', { className: 'flex items-center gap-3' },
                                React.createElement('img', { src: logo, className: 'h-20 w-20 object-contain' }),
                                React.createElement('button', {
                                    onClick: () => setCurr(null),
                                    className: 'text-gray-400 hover:text-gray-600 text-sm'
                                }, 'Salir')
                            )
                        ),

                        (curr.destination || curr.start_date) && React.createElement('div', { className: 'bg-gray-50 rounded-lg p-4 mb-4' },
                            React.createElement('div', { className: 'flex flex-wrap gap-3 text-sm text-gray-600' },
                                curr.destination && React.createElement('div', { className: 'flex items-center gap-2' },
                                    React.createElement('span', {}, 'ðŸ“'),
                                    React.createElement('span', {}, curr.destination)
                                ),
                                curr.start_date && curr.end_date && React.createElement('div', { className: 'flex items-center gap-2' },
                                    React.createElement('span', {}, 'ðŸ“…'),
                                    React.createElement('span', {}, fmt(curr.start_date) + ' - ' + fmt(curr.end_date))
                                )
                            )
                        ),

                        docs.length > 0 && React.createElement('div', { className: 'flex justify-between items-center' },
                            React.createElement('p', { className: 'text-sm text-gray-500' }, docs.length + ' archivo' + (docs.length !== 1 ? 's' : '')),
                            React.createElement('button', {
                                onClick: downloadAll,
                                className: 'px-4 py-2 bg-[#197751] text-white rounded-lg hover:bg-[#145a3e] text-sm'
                            }, 'Descargar Todos')
                        )
                    ),

                    !vis.length ? React.createElement('div', { className: 'text-center py-16' },
                        React.createElement('div', { className: 'text-6xl mb-4' }, 'ðŸ“„'),
                        React.createElement('p', { className: 'text-gray-400' }, 'No hay documentos disponibles')
                    ) : React.createElement('div', { className: 'space-y-6' },
                        vis.map(k => {
                            const catDocs = getDocsByCat(k);
                            return React.createElement('div', { key: k },
                                React.createElement('h2', { className: 'text-lg font-semibold text-gray-700 mb-2 flex items-center gap-2' },
                                    React.createElement('span', {}, cats[k].i),
                                    React.createElement('span', {}, cats[k].n)
                                ),
                                React.createElement('div', { className: 'space-y-2' },
                                    catDocs.map(d => React.createElement('div', { key: d.id, className: 'flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-gray-100' },
                                        React.createElement('span', { className: 'text-gray-700 text-sm flex-1 truncate' }, d.display_name),
                                        React.createElement('button', {
                                            onClick: () => download(d),
                                            className: 'px-4 py-2 bg-[#197751] text-white rounded-lg hover:bg-[#145a3e] text-sm ml-3'
                                        }, 'Descargar')
                                    ))
                                )
                            );
                        })
                    ),

                    React.createElement('div', { className: 'mt-12 pt-6 border-t border-gray-200' },
                        React.createElement('div', { className: 'flex justify-center gap-6' },
                            React.createElement('a', {
                                href: 'https://instagram.com/tripnenjoy',
                                target: '_blank',
                                className: 'text-gray-400 hover:text-gray-600'
                            }, '@tripnenjoy'),
                            React.createElement('a', {
                                href: 'https://wa.me/5491126092015',
                                target: '_blank',
                                className: 'text-gray-400 hover:text-gray-600'
                            }, '+54 911 2609-2015')
                        )
                    )
                )
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>
